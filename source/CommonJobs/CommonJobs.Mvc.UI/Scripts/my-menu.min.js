var __extends=this.__extends||function(n,t){function i(){this.constructor=n}i.prototype=t.prototype,n.prototype=new i},Utilities,MyMenu;(function(n){function r(n,t){var i=moment(n),r=moment(t);return!n||!t||!i||!r?NaN:(i.hours(0).minutes(0).seconds(0).milliseconds(0),r.hours(0).minutes(0).seconds(0).milliseconds(0),i.diff(r,"days"))}function u(){var n=ko.observable(!1);return n.register=function(t){t.subscribe(function(){n(!0)})},n.reset=function(){return n(!1)},n}var t,i,f;n.daysDiff=r,n.dirtyFlag=u,t=function(){function n(n,t){typeof n=="undefined"&&(n="abcdefghijklmnopqrstuvwxyz1234567890"),typeof t=="undefined"&&(t=8),this.chars=n,this.length=t}return n.prototype.generate=function(n){typeof n=="undefined"&&(n="");var t=this.chars,i=t.length;return n+_.map(_.range(this.length),function(){return t[_.random(0,i)]}).join("")},n}(),n.IdGenerator=t,n.idGenerator=new t,i=function(){function n(){var r=this,t=this.constructor,i,n;if(!t.__cb__){t.__cb__={};for(n in this)i=this[n],typeof i=="function"&&n.indexOf("__cb__")==-1&&(t.__cb__[n]=i)}for(n in t.__cb__)(function(n,t){r[n]=function(){return t.apply(r,Array.prototype.slice.call(arguments))}})(n,t.__cb__[n])}return n}(),n.HasCallbacks=i,function(t){function i(n,t,i){var r=_.map(ko.toJS(t),function(n){return n.Text}),u=r.length+1,i;if(i&&(i.Text&&(i=i.Text),_.isString(i))){if(r.indexOf(i)==-1)return i;n=i,u=2}for(;;)if(i=n+u++,r.indexOf(i)==-1)return i}function r(t,r,u,f){var e,o;return f&&f.Key?e={Key:f.Key,Text:ko.observable(f.Text)}:(o=i(r,t,f),e={Key:n.idGenerator.generate(u),Text:ko.observable(o)}),t.push(e),e}function u(n,t,i){if(typeof i=="undefined"&&(i="Key"),!n().length)return null;if(_.isString(t))return n.remove(function(n){return n[i]==t});var r=_.isNumber(t)?t:n.indexOf(t);return n.splice(r,1)[0]}t.addKeyObservableText=r,t.removeItem=u}(n.ObservableArrays||(n.ObservableArrays={})),f=n.ObservableArrays})(Utilities||(Utilities={})),function(n){var f=function(){function n(n,t,i){var o=this,r=_.isFunction(n),u=_.isFunction(t),f=_.isFunction(i),e;this.StartDate=r?function(){return moment(n())}:function(){return moment(n)},this.WeeksQuantity=u?t:function(){return t},f?this.FirstWeekIdx=function(){return i()||0}:(i=i||0,this.FirstWeekIdx=function(){return i}),r||u||f?this.ZeroWeekZeroDay=function(){return o.calculateZeroWeekZeroDay()}:(e=this.calculateZeroWeekZeroDay(),this.ZeroWeekZeroDay=function(){return e})}return n.prototype.calculateZeroWeekZeroDay=function(){return this.StartDate().day(0).add("weeks",-1*this.FirstWeekIdx())},n.prototype.week=function(n){var t=this.WeeksQuantity(),r=moment(n).day(0),i=r.diff(this.ZeroWeekZeroDay(),"weeks");return i<0?t+i%t:i%t},n.prototype.day=function(n){return moment(n).day()},n.prototype.match=function(n,t,i){return n==this.week(i)&&t==this.day(i)},n.prototype.near=function(n,t,i){var u=this.WeeksQuantity(),r;if(u<=n||(r=moment(i),!r.isValid))return null;while(!this.match(n,t,r))r.add("days",1);return r},n}(),u;n.days=function(){var t=[1,2,3,4,5],n=function(){return t};return n.getName=function(n){return moment().day(n).format("dddd")},n.isValid=function(n){return t.indexOf(n)>=0},n}();var t=function(t){function i(n){var i=this;t.call(this),this.isDirty=Utilities.dirtyFlag(),this.WeeksQuantity=ko.observable(0),this.isDirty.register(this.WeeksQuantity),this.Weeks=ko.computed(function(){return _.map(_.range(i.WeeksQuantity()),function(n){return{Key:n.toString(),Text:"Semana "+(n+1)}})}),this.WeekStorageReset(n)}return __extends(i,t),i.prototype.setWeeksQuantity=function(n){this.WeeksQuantity(n)},i.prototype.reset=function(n){this.WeekStorageReset(n)},i.prototype.WeekStorageReset=function(n){var t;if(this.setWeeksQuantity(0),this.items=[],n)for(t=0;t<n;t++)this.addWeek()},i.prototype.addWeek=function(){for(var t=[],i,n=0;n<7;n++)i=this.createNewItem(),t.push(i);this.items.push(t),this.setWeeksQuantity(this.WeeksQuantity()+1)},i.prototype.removeWeek=function(){var n=this.WeeksQuantity();n>0&&(this.setWeeksQuantity(n-1),this.items.pop())},i.prototype.createNewItem=function(){return null},i.prototype.getItem=function(t,i){return n.days.isValid(i)&&t<this.WeeksQuantity()?this.items[t][i]:null},i.prototype.eachWeek=function(n){_.each(this.items,function(t,i){return n(t,i)})},i.prototype.eachDay=function(n){this.eachWeek(function(t,i){return _.each(t,function(t,r){return n(t,i,r)})})},i}(Utilities.HasCallbacks),i=function(){function n(){this.OptionKey=ko.observable(""),this.PlaceKey=ko.observable("")}return n}(),r=function(n){function t(t){n.call(this),this.Date=ko.observable(""),this.Cancel=ko.observable(!1),this.Comment=ko.observable(""),t&&(this.OptionKey(t.OptionKey),this.PlaceKey(t.PlaceKey),this.Date(t.Date),this.Cancel(t.Cancel),this.Comment(t.Comment))}return __extends(t,n),t}(i),e=function(n){function t(t,i,r){n.call(this,t.WeeksQuantity()),this.menu=t,this.MenuId=ko.observable(""),this.DefaultPlaceKey=ko.observable(""),this.Overrides=ko.observableArray([]),this.now=ko.observable(),this.isDirty.register(this.MenuId),this.isDirty.register(this.DefaultPlaceKey),this.isDirty.register(this.Overrides),this.EmployeeMenuDefinitionReset(i),this.calendarHelper=new f(t.StartDate,t.WeeksQuantity,t.FirstWeekIdx),this.now(r)}return __extends(t,n),t.prototype.reset=function(t){n.prototype.reset.call(this,this.menu.WeeksQuantity()),this.EmployeeMenuDefinitionReset(t),this.isDirty(!1)},t.prototype.nearFormated=function(n,t){var f=moment(this.now()),u=this.calendarHelper.near(+n,t,f),i,r;return u==null?null:(i=u.diff(f,"days",!0),r=u.format("D [de] MMMM [de] YYYY"),i==0?"Hoy ("+r+")":i==1?"Mañana ("+r+")":i==2?"Pasado mañana ("+r+")":i<7?"En "+i+" días ("+r+")":r)},t.prototype.createNewItem=function(){var n=new i;return this.isDirty.register(n.OptionKey),this.isDirty.register(n.PlaceKey),n},t.prototype.eachWeek=function(t){n.prototype.eachWeek.call(this,t)},t.prototype.eachDay=function(t){n.prototype.eachDay.call(this,t)},t.prototype.getItem=function(t,i){return n.prototype.getItem.call(this,t,i)},t.prototype.getMenuChoice=function(n,t){var i=this.getItem(n,t);return i&&i.OptionKey},t.prototype.getPlaceChoice=function(n,t){var i=this.getItem(n,t);return i&&i.PlaceKey},t.prototype.getChoicesByDate=function(n){var f=this.calendarHelper.week(n),e=this.calendarHelper.day(n),i=this.DefaultPlaceKey(),t=null,a=null,u=null,o=null,s=null,h=this.getItem(f,e),r,c,l;return h&&(i=h.PlaceKey()||i,t=h.OptionKey()||t),r=_.last(_.filter(this.Overrides(),function(t){return Utilities.daysDiff(t.Date(),n)===0})),r&&(a=r.Comment(),r.Cancel()?(i=null,t=null):(i=r.PlaceKey()||i,t=r.OptionKey()||t)),u=t&&this.menu.getFood(f,e,t)(),c=i&&_.find(this.menu.Places(),function(n){return n.Key==i}),s=c?c.Text():null,l=t&&_.find(this.menu.Options(),function(n){return n.Key==t}),o=l?l.Text():null,u&&i||(s=null,o=null,u=null),{Date:n,Place:s,Option:o,Food:u,Comment:a,WeekIdx:f,DayIdx:e}},t.prototype.getDefaultPlaceLabel=function(){var t=this.DefaultPlaceKey(),i=this.menu.Places(),n=_.find(i,function(n){return n.Key==t});return n?"Lugar por defecto ("+n.Text()+")":"Seleccione un lugar (no se definió el lugar por defecto)"},t.prototype.getDayWeekLabel=function(n){var t=moment(ko.utils.unwrapObservable(n));return!t||!t.isValid?"Seleccione un día válido":t.format("dddd")+" de Semana "+(this.calendarHelper.week(t)+1)},t.prototype.getDayWeekOptionOverrideInfo=function(n,t){var i=moment(ko.utils.unwrapObservable(n));if(!i||!i.isValid)return"Atención! Seleccione un día válido";var r=this.calendarHelper.week(i),u=this.calendarHelper.day(i),f=ko.utils.unwrapObservable(t)||ko.utils.unwrapObservable(this.getMenuChoice(r,u)),e=ko.utils.unwrapObservable(this.menu.getFood(r,u,f));return e||"Atención! no hay comida seleccionada para este día"},t.prototype.getDayWeekPlaceOverrideInfo=function(n,t){var i=moment(ko.utils.unwrapObservable(n));if(!i||!i.isValid)return"Atención! Seleccione un día válido";var u=this.calendarHelper.week(i),f=this.calendarHelper.day(i),e=ko.utils.unwrapObservable(t)||ko.utils.unwrapObservable(this.getPlaceChoice(u,f))||ko.utils.unwrapObservable(this.DefaultPlaceKey),o=this.menu.Places(),r=_.find(o,function(n){return n.Key==e}),s=r&&r.Text;return s||"Atención! no hay lugar seleccionado para este día"},t.prototype.EmployeeMenuDefinitionReset=function(n){var t=this;n=_.extend({UserName:"",Id:"",EmployeeName:"",DefaultPlaceKey:""},n),this.MenuId(n.MenuId),this.Id=n.Id,this.UserName=n.UserName,this.EmployeeName=n.EmployeeName,this.DefaultPlaceKey(n.DefaultPlaceKey),n.WeeklyChoices&&_.each(n.WeeklyChoices,function(n){var i=t.getItem(n.WeekIdx,n.DayIdx);i&&(i.OptionKey(n.OptionKey),i.PlaceKey(n.PlaceKey))}),this.Overrides.removeAll(),n.Overrides&&_.each(n.Overrides,function(n){var i=new r(n);t.Overrides.push(i),t.isDirty.register(i.OptionKey),t.isDirty.register(i.PlaceKey),t.isDirty.register(i.Date),t.isDirty.register(i.Cancel),t.isDirty.register(i.Comment)})},t.prototype.exportData=function(){var n={MenuId:this.MenuId(),Id:this.Id,UserName:this.UserName,EmployeeName:this.EmployeeName,DefaultPlaceKey:this.DefaultPlaceKey(),WeeklyChoices:[],Overrides:[]},t=n.WeeklyChoices;return this.eachDay(function(n,i,r){var e=n.OptionKey(),u,f;e&&(u={WeekIdx:i,DayIdx:r,OptionKey:e},f=n.PlaceKey(),f&&(u.PlaceKey=f),t.push(u))}),n.Overrides=ko.toJS(this.Overrides),n},t.prototype.addOverride=function(){var n=new r;this.Overrides.push(n),this.isDirty.register(n.OptionKey),this.isDirty.register(n.PlaceKey),this.isDirty.register(n.Date),this.isDirty.register(n.Cancel),this.isDirty.register(n.Comment)},t.prototype.removeOverride=function(n){Utilities.ObservableArrays.removeItem(this.Overrides,n,"date")},t}(t);n.EmployeeMenuDefinition=e,u=function(n){function t(t){n.call(this,t&&t.WeeksQuantity),this.Id=ko.observable(""),this.Title=ko.observable(""),this.Options=ko.observableArray(),this.Places=ko.observableArray(),this.StartDate=ko.observable(""),this.EndDate=ko.observable(""),this.DeadlineTime=ko.observable(""),this.LastSentDate=ko.observable(""),this.FirstWeekIdx=ko.observable(0),this.isDirty.register(this.Id),this.isDirty.register(this.Title),this.isDirty.register(this.Options),this.isDirty.register(this.Places),this.isDirty.register(this.StartDate),this.isDirty.register(this.EndDate),this.isDirty.register(this.DeadlineTime),this.isDirty.register(this.FirstWeekIdx),this.isDirty.register(this.LastSentDate),this.MenuDefinitionReset(t)}return __extends(t,n),t.defaultData={Id:"Menu/DefaultMenu",Title:"Nuevo Menú",FirstWeekIdx:0,WeeksQuantity:0,Options:[],Places:[],StartDate:"2000-01-01",EndDate:"2100-01-01",LastSentDate:"2000-01-01",DeadlineTime:"09:30",Foods:[]},t.idGenerator=new Utilities.IdGenerator,t.prototype.createNewItem=function(){var t=this,n={};return this.Options&&_.each(this.Options(),function(i){var r=ko.observable("");n[i.Key]=r,t.isDirty.register(r)}),n},t.prototype.getItem=function(t,i){return n.prototype.getItem.call(this,t,i)},t.prototype.getFood=function(n,t,i){this.WeeksQuantity(),this.Options();var r=this.getItem(n,t);return r&&r[i]},t.prototype.eachWeek=function(t){n.prototype.eachWeek.call(this,t)},t.prototype.eachDay=function(t){n.prototype.eachDay.call(this,t)},t.prototype.MenuDefinitionReset=function(n){var r=this,i;n=$.extend({},t.defaultData,n),this.Id(n.Id),this.Title(n.Title),this.StartDate(n.StartDate),this.EndDate(n.EndDate),this.FirstWeekIdx(n.FirstWeekIdx),this.DeadlineTime(n.DeadlineTime),this.LastSentDate(n.LastSentDate),this.Places.removeAll();for(i in n.Places)this.addPlace(n.Places[i]);this.Options.removeAll();for(i in n.Options)this.addOption(n.Options[i]);n&&n.Foods&&_.each(n.Foods,function(n){var t=r.getFood(n.WeekIdx,n.DayIdx,n.OptionKey);t&&t(n.Food)}),this.isDirty.reset()},t.prototype.reset=function(t){n.prototype.reset.call(this,t&&t.WeeksQuantity),this.MenuDefinitionReset(t)},t.prototype.exportData=function(){var n={Id:this.Id(),DeadlineTime:this.DeadlineTime(),LastSentDate:this.LastSentDate(),Title:this.Title(),FirstWeekIdx:this.FirstWeekIdx(),WeeksQuantity:this.WeeksQuantity(),StartDate:this.StartDate(),EndDate:this.EndDate(),Places:ko.toJS(this.Places),Options:ko.toJS(this.Options),Foods:[]};return this.eachDay(function(t,i,r){var f,u;for(u in t)(f=t[u]())&&n.Foods.push({WeekIdx:i,DayIdx:r,OptionKey:u,Food:f})}),n},t.prototype.addOption=function(n){var i=this,t=Utilities.ObservableArrays.addKeyObservableText(this.Options,"Menú ","menu_",n);this.isDirty.register(t.Text),this.eachDay(function(n){var r=ko.observable("");n[t.Key]=r,i.isDirty.register(r)}),this.Options.valueHasMutated()},t.prototype.removeOption=function(n){var t=Utilities.ObservableArrays.removeItem(this.Options,n);t&&this.eachDay(function(n){return delete n[t.Key]})},t.prototype.addPlace=function(n){var n=Utilities.ObservableArrays.addKeyObservableText(this.Places,"Lugar ","place_",n);this.isDirty.register(n.Text)},t.prototype.removePlace=function(n){Utilities.ObservableArrays.removeItem(this.Places,n)},t}(t),n.MenuDefinition=u}(MyMenu||(MyMenu={}))